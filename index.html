<!doctype html>
<html>
    <head>
      <title>Socket.IO</title>
    </head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="js/qrious.js"></script>
    <script src="js/NoSleep.js"></script>
    <script src="js/ifvisible.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-auth.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyBlPLppOtBkBo6XYq3wm17EGNOy8FhsUpM",
            authDomain: "shutappsweb.firebaseapp.com",
            databaseURL: "https://shutappsweb.firebaseio.com",
            projectId: "shutappsweb",
            storageBucket: "",
            messagingSenderId: "336718505369"
        };
        firebase.initializeApp(config);
    </script>        
    <script>
    $(function() {
        var socket = io();
        var sessionId = '';
        var session = '';
        var counter = 0;
        var myTimer;
        var noSleep = new NoSleep();
        var wakeLockEnabled = false;
        var started = false;
        
        socket.on('connect', function () {
            sessionId = socket.io.engine.id;
            //console.log('Connected ' + sessionId);    
        });
        
        firebase.auth().onAuthStateChanged(function(user) {
            if(user) {
                console.log('user is logged in');
                firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
                    var data = {
                        idToken: idToken
                    };
                    socket.emit('auth', data);
                }).catch(function(error) {
                    console.log(error);
                });
            } else {
                console.log('user is not logged in');
                alert('Sie sind nicht eingeloggt!');
                window.stop();
                window.location.replace('/');
            }
        });
        
        document.addEventListener('visibilitychange', function(e) {
            if(document.hidden) {
                socket.io.disconnect();
                clearInterval(myTimer);
                counter = 0;
                document.getElementById("counter").innerHTML = formatTime(counter); 
                $('#clients').empty();
                console.log('tab');
            } else {
                socket.io.connect();
                console.log('kein tab');
            }
        });
        
        var createForm = $('#create');
        var joinForm = $('#join');
        var startForm = $('#start');
        var pauseForm = $('#pause');
        var leaveForm = $('#leave');
        
        $(createForm).submit(function() {
            event.preventDefault();
            socket.emit('create', sessionId);
            console.log(sessionId);
            document.getElementById("counter").innerHTML = formatTime(counter); 
        });
        
        $(joinForm).submit(function() {
            event.preventDefault();
            var roomId = $('#text').val();
            socket.emit('join', roomId);
            session = roomId;
            document.getElementById("counter").innerHTML = formatTime(counter); 
        });
        
        $(startForm).submit(function() {
            event.preventDefault();
            socket.emit('start', session);
            noSleep.enable();
        });
        
        $(pauseForm).submit(function() {
            event.preventDefault();
            socket.emit('pause', session);
            noSleep.disable();
        });
        
        $(leaveForm).submit(function() {
            event.preventDefault();
            socket.emit('leave', { id: sessionId, roomId: session})
            $('ul').empty();
            clearInterval(myTimer);
            counter = 0;
            document.getElementById("counter").innerHTML = formatTime(counter); 
            $('li').remove();
        });
        
        socket.on('roomId', function(roomId) {
            $('#roomText').text(roomId);
            var qr = new QRious({
                element: document.getElementById('roomId'),
                value: 'https://shutappsweb.herokuapp.com/start/' + roomId
            });
            session = roomId;
            //$('#roomHint').text("Bitte QR-Code zum Einladen benutzen!");
        });
        
        socket.on('joinedRoom', function(joinedRoom) {
            session = joinedRoom;
            document.getElementById("counter").innerHTML = formatTime(counter); 
            $('#joinedRoom').text(socket.io.engine.id + " joined " + joinedRoom); 
        });
        
        socket.on('clients', function(data) {
            var seen = [];
            $('#clients li').each(function(i, li) {
                seen.push($(li).text());
            });
            data.forEach(function(element) {
                if(jQuery.inArray(element, seen) == -1) {
                    $('#clients').append("<li>" + element + "</li>");
                }
            });
        });
        
        socket.on('startCounter', function(data) {
            if(data === 'startCounter' && !started) {
                started = true;
                myTimer = setInterval(function() {
                    socket.emit('counter', counter);
                    document.getElementById("counter").innerHTML = formatTime(counter); 
                    counter++;
                }, 1000);        
            }
        });
        
        socket.on('pauseCounter', function(data) {
            if(data === 'pauseCounter') {
                clearInterval(myTimer);
                started = false;
            }
        });
        
        socket.on('leave', function(data) {
            $('li').filter(function() { 
                return $.text([this]) === data.clientId; 
            }).remove();
            if(counter == 0) {
                $('#notify').append(data.clientId + " has left the session and lasts " + formatTime(0) + "<br>");
            } else {
                $('#notify').append(data.clientId + " has left the session and lasts " + formatTime(data.counter) + "<br>");
            }
            started = false;
        });
        
        socket.on('left', function(data) {
            console.log(data);
            if(data == 'left') {
                alert('Du hast ' + counter + ' ausgehalten!');
            }
        });
    }); 
        
    function formatTime(seconds) {
        var h = Math.floor(seconds / 3600);
        var m = Math.floor(seconds / 60) % 60;
        var s = seconds % 60;
        if(h < 10) 
            h = "0" + h;
        if(m < 10) 
            m = "0" + m;
        if(s < 10) 
            s = "0" + s;
        return h + ":" + m + ":" + s;
    }
        
    function signOut() {
        firebase.auth().signOut().then(function() {
            console.log('user has logged out');
        }).catch(function(error) {
            console.log(error);
        });
    };
        
    window.onload = function() {
        document.getElementById('sign-out').addEventListener('click', signOut, false);
    };
    </script>
    <body>
        <form id="create">
            <input type="submit" value="create session">
        </form>
        <canvas id="roomId"></canvas>
        <p id="roomHint"></p>
        <p id="roomText"></p>
        <form id="join">
            <input type="text" id="text">
            <input type="submit" value="join session">
        </form>
        <p id="joinedRoom"></p>
        <form id="start">
            <input type="submit" value="start session">
        </form>
        <p id="counter"></p>
        <form id="pause">
            <input type="submit" value="pause session">
        </form>
        <p>Clients in der Session:</p>
        <ul id="clients"></ul>
        <form id="leave">
            <input type="submit" value="leave session">
        </form>
        <p id="notify"></p>
        <button id="sign-out" name="sign-out">Sign Out</button>
    </body>
</html>