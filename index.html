<!doctype html>
<html>
    <head>
      <title>Socket.IO</title>
    </head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="js/qrious.js"></script>
    <script>
    $(function() {
        var socket = io();
        var sessionId = '';
        var session = '';
        var counter = 0;
        var myTimer;
        
        socket.on('connect', function () {
            sessionId = socket.io.engine.id;
            console.log('Connected ' + sessionId);    
        });
        
        var createForm = $('#create');
        var joinForm = $('#join');
        var startForm = $('#start');
        var pauseForm = $('#pause');
        
        $(createForm).submit(function() {
            event.preventDefault();
            socket.emit('create', sessionId);
        });
        
        $(joinForm).submit(function() {
            event.preventDefault();
            var roomId = $('#text').val();
            socket.emit('join', roomId);
            session = roomId;
        });
        
        $(startForm).submit(function() {
            event.preventDefault();
            socket.emit('start', session);
        });
        
        $(pauseForm).submit(function() {
            event.preventDefault();
            socket.emit('pause', session);
        });
        
        socket.on('roomId', function(roomId) {
            $('#roomText').text(roomId);
            var qr = new QRious({
                element: document.getElementById('roomId'),
                value: 'https://shutappsweb.herokuapp.com/' + roomId
            });
            session = roomId;
            $('#roomHint').text("Bitte QR-Code zum Einladen benutzen!");
        });
        
        socket.on('joinedRoom', function(joinedRoom) {
            $('#joinedRoom').text(socket.io.engine.id + " joined " + joinedRoom); 
        });
        
        socket.on('startCounter', function(data) {
            if(data === 'startCounter') {
                myTimer = setInterval(function() {
                    document.getElementById("counter").innerHTML = formatTime(counter); 
                    counter++;
                }, 1000);        
            }
        });
        
        socket.on('pauseCounter', function(data) {
            if(data === 'pauseCounter') {
                clearInterval(myTimer);
            }
        });
    }); 
        
    function formatTime(seconds) {
        var h = Math.floor(seconds / 3600);
        var m = Math.floor(seconds / 60) % 60;
        var s = seconds % 60;
        if(h < 10) 
            h = "0" + h;
        if(m < 10) 
            m = "0" + m;
        if(s < 10) 
            s = "0" + s;
        return h + ":" + m + ":" + s;
    }
    </script>
    <body>
        <form id="create">
            <input type="submit" value="create session">
        </form>
        <canvas id="roomId"></canvas>
        <p id="roomHint"></p>
        <p id="roomText"></p>
        <form id="join">
            <input type="text" id="text">
            <input type="submit" value="join session">
        </form>
        <p id="joinedRoom"></p>
        <form id="start">
            <input type="submit" value="start session">
        </form>
        <p id="counter"></p>
        <form id="pause">
            <input type="submit" value="pause session">
        </form>
    </body>
</html>