<!doctype html>
<html>
    <head>
      <title>Socket.IO</title>
    </head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="js/qrious.js"></script>
    <script src="js/NoSleep.js"></script>
    <script>
    $(function() {
        var socket = io();
        var sessionId = '';
        var session = '';
        var counter = 0;
        var myTimer;
        var noSleep = new NoSleep();
        var wakeLockEnabled = false;
        var started = false;
        
        socket.on('connect', function () {
            sessionId = socket.io.engine.id;
            console.log('Connected ' + sessionId);    
        });
        
        var createForm = $('#create');
        var joinForm = $('#join');
        var startForm = $('#start');
        var pauseForm = $('#pause');
        var leaveForm = $('#leave');
        
        $(createForm).submit(function() {
            event.preventDefault();
            socket.emit('create', sessionId);
            document.getElementById("counter").innerHTML = formatTime(counter); 
        });
        
        $(joinForm).submit(function() {
            event.preventDefault();
            var roomId = $('#text').val();
            socket.emit('join', roomId);
            session = roomId;
            document.getElementById("counter").innerHTML = formatTime(counter); 
        });
        
        $(startForm).submit(function() {
            event.preventDefault();
            socket.emit('start', session);
            noSleep.enable();
        });
        
        $(pauseForm).submit(function() {
            event.preventDefault();
            socket.emit('pause', session);
            noSleep.disable();
        });
        
        $(leaveForm).submit(function() {
            event.preventDefault();
            socket.emit('leave', { id: sessionId, roomId: session})
            $('ul').empty();
            clearInterval(myTimer);
            counter = 0;
            document.getElementById("counter").innerHTML = formatTime(counter); 
            $('#notify').empty();
        });
        
        socket.on('roomId', function(roomId) {
            $('#roomText').text(roomId);
            var qr = new QRious({
                element: document.getElementById('roomId'),
                value: 'https://shutappsweb.herokuapp.com/?id=' + roomId
            });
            session = roomId;
            //$('#roomHint').text("Bitte QR-Code zum Einladen benutzen!");
        });
        
        socket.on('joinedRoom', function(joinedRoom) {
            $('#joinedRoom').text(socket.io.engine.id + " joined " + joinedRoom); 
        });
        
        socket.on('clients', function(data) {
            var seen = [];
            $('#clients li').each(function(i, li) {
                seen.push($(li).text());
            });
            data.forEach(function(element) {
                if(jQuery.inArray(element, seen) == -1) {
                    $('#clients').append("<li>" + element + "</li>");
                }
            });
        });
        
        socket.on('startCounter', function(data) {
            if(data === 'startCounter' && !started) {
                started = true;
                myTimer = setInterval(function() {
                    document.getElementById("counter").innerHTML = formatTime(counter); 
                    counter++;
                    socket.emit('counter', counter);
                }, 1000);        
            }
        });
        
        socket.on('pauseCounter', function(data) {
            if(data === 'pauseCounter') {
                clearInterval(myTimer);
                started = false;
            }
        });
        
        socket.on('leave', function(data) {
            $('li').filter(function() { 
                return $.text([this]) === data.clientId; 
            }).remove();
            $('#notify').append(data.clientId + " has left the session and lasts " + formatTime(data.counter) + "<br>");
            started = false;
        });
    }); 
        
    function formatTime(seconds) {
        var h = Math.floor(seconds / 3600);
        var m = Math.floor(seconds / 60) % 60;
        var s = seconds % 60;
        if(h < 10) 
            h = "0" + h;
        if(m < 10) 
            m = "0" + m;
        if(s < 10) 
            s = "0" + s;
        return h + ":" + m + ":" + s;
    }
    </script>
    <body>
        <form id="create">
            <input type="submit" value="create session">
        </form>
        <canvas id="roomId"></canvas>
        <p id="roomHint"></p>
        <p id="roomText"></p>
        <form id="join">
            <input type="text" id="text">
            <input type="submit" value="join session">
        </form>
        <p id="joinedRoom"></p>
        <form id="start">
            <input type="submit" value="start session">
        </form>
        <p id="counter"></p>
        <form id="pause">
            <input type="submit" value="pause session">
        </form>
        <p>Clients in der Session:</p>
        <ul id="clients"></ul>
        <form id="leave">
            <input type="submit" value="leave session">
        </form>
        <p id="notify"></p>
    </body>
</html>